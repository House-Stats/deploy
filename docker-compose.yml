version: "3.9" 

services:
  pgadmin:
    image: dpage/pgadmin4
    restart: always
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@admin.com
      PGADMIN_DEFAULT_PASSWORD: root
    volumes:
      - pgadmin-data:/var/lib/pgadmin
    ports:
      - "5050:80"
    networks:
      - net

  # Auto Update Containers
  watchtower:
    image: containrrr/watchtower
    container_name: watchtower
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./config.json:/config.json
    environment:
      WATCHTOWER_NOTIFICATION_URL:
    command: --interval 30 deploy-worker-1 deploy-worker-2 deploy-worker-3 deploy-worker-4 	deploy-sales_ingest-1 	deploy-sales_ingest-2 	deploy-sales_ingest-3 	deploy-sales_ingest-4 	deploy-update_checker-1 	deploy-web_api-1 	deploy-web_api-2 	deploy-web_api-3 	deploy-web_api-4 

  # Sale ingest
  sales_ingest:
    image: ghcr.io/house-stats/sales-ingest:main
    restart: "always"
    environment:
      DBNAME: "house_data"
      POSTGRES_USER:
      POSTGRES_PASSWORD:
      POSTGRES_HOST:
      KAFKA:
      NODENAME: '{{.Node.Hostname}}'
      PYTHONUNBUFFERED: "1"
    deploy:
      mode: replicated
      replicas: 4
    cpus: 1
    networks:
      - net

  web_api:
    image: ghcr.io/house-stats/web-api:main
    restart: "always"
    environment:
      DBNAME: "house_data"
      POSTGRES_USER:
      POSTGRES_PASSWORD:
      POSTGRES_HOST:
      MONGO_HOST:
      MONGO_USERNAME:
      MONGO_PASSWORD:
      CELERY_BROKER_URL:
      CELERY_RESULT_BACKEND:
      PYTHONUNBUFFERED: "1"
      cpus: 2
    ports:
      - "9800-9810:8000"
    deploy:
      mode: replicated
      replicas: 4
    networks:
      - net
    depends_on:
      - worker

  worker:
    image: ghcr.io/house-stats/web-api:main
    entrypoint: celery
    command: "--app=app.celery worker --loglevel=info --concurrency=4"
    restart: "always"
    cpus: 2
    environment:
      DBNAME: "house_data"
      POSTGRES_USER:
      POSTGRES_PASSWORD:
      POSTGRES_HOST:
      MONGO_HOST:
      MONGO_USERNAME:
      MONGO_PASSWORD:
      CELERY_BROKER_URL:
      CELERY_RESULT_BACKEND:
      PYTHONUNBUFFERED: "1"
    deploy:
      mode: replicated
      replicas: 4
    networks:
      - net
    depends_on:
      - rabbit_mq
      - redis

  update_checker:
    image: ghcr.io/house-stats/update-check:main
    restart: "always"
    environment:
      POSTGRES_USER:
      POSTGRES_PASSWORD:
      POSTGRES_HOST:
      KAFKA:
      PYTHONUNBUFFERED: "1"
    networks:
      - net

  rabbit_mq:
    image: rabbitmq:3-management
    ports:
      - "15672:15672"
      - "5672:5672"
    environment:
      RABBITMQ_DEFAULT_USER:
      RABBITMQ_DEFAULT_PASS:
    networks:
      - net

  redis:
    image: redis:latest
    ports:
      - '6379:6379'
    command: redis-server --save 300 1
    volumes: 
      - cache:/data
    networks:
      - net

volumes:
  pgadmin-data:
  cache:

networks:
  net:
